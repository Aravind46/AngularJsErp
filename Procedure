
CREATE PROCEDURE CST_BILL_PROC
@QRY_ID VARCHAR(50),
@XMLdATA TEXT =NULL
AS

	DECLARE 
	@XMLID INT,
	@CST_ID_TEMP  VARCHAR (20)  ,
	@TEMPCOL VARCHAR(MAX),
	@TEMPCOL1 VARCHAR(MAX),
	@TEMPDATE VARCHAR(100)

	
	IF @XMLdATA IS NOT NULL
	 BEGIN
		EXEC SP_XML_PREPAREDOCUMENT @XMLID OUTPUT,@XMLDATA

		IF @QRY_ID='CST_INSERT'
		BEGIN
			
			BEGIN TRANSACTION
				INSERT INTO CUSTOMER_MAS(CST_ID,CST_BLK_ID,CST_FLAT_NO,CST_MOBILE,CST_NAME,CST_REMARK)
				SELECT * FROM OPENXML(@XMLID,'/root/row',2)
				WITH (  [CST_ID]  VARCHAR (20),
						[CST_BLK_ID]  VARCHAR (10),
						[CST_FLAT_NO] VARCHAR (20),
						CST_MOBILE INT,
						CST_NAME VARCHAR(200),
						CST_REMARK VARCHAR(500)

					)		
				
				--SELECT @CST_ID_TEMP=[CST_ID]   FROM OPENXML(@XMLID,'/root/row',2)
				--WITH (  [CST_ID]  VARCHAR (20))
				
				--INSERT INTO ORDER_MAS([PRD_NAME],PRD_ID,ORD_QTY,CST_ID)				
				--SELECT *,@CST_ID_TEMP AS [CST_ID] FROM OPENXML(@XMLID,'/root/ordrow',2)
				--WITH (
				--	[PRD_NAME]  VARCHAR(200),			
				--	[PRD_ID]  INT,			
				--	[ORD_QTY] INT
				--  )
						

				SELECT 'SUCCESS';
				
				COMMIT TRANSACTION
		END
		IF @QRY_ID='CST_SELECT'
			BEGIN
				SELECT * FROM CUSTOMER_MAS;
			END
		--IF @QRY_ID='CST_UPDATE'
		--	BEGIN			
				
		--		SELECT * INTO #TempUpdte FROM OPENXML(@XMLID,'/root/row',2)
		--		WITH (  [CST_ID]	  VARCHAR (10),
		--				[CST_BLK_ID]  VARCHAR (10),
		--				[CST_FLAT_NO] VARCHAR (20)	--									
			
		--		SELECT @CST_ID_TEMP=[CST_ID]   FROM OPENXML(@XMLID,'/root/row',2)
		--		WITH (  [CST_ID]  VARCHAR (20))

				
		--		UPDATE  CUSTOMER_MAS
		--		SET CUSTOMER_MAS.CST_ADV =#TempUpdte.CST_ADV,
		--			CUSTOMER_MAS.CST_CONV=#TempUpdte.CST_CONV,
		--			CUSTOMER_MAS.CST_DIS=#TempUpdte.CST_DIS
		--		FROM #TempUpdte
		--		WHERE CUSTOMER_MAS.CST_ID= #TempUpdte.CST_ID
				
		--		DELETE FROM ORDER_MAS
		--		WHERE CST_ID=@CST_ID_TEMP

		--		INSERT INTO ORDER_MAS([PRD_NAME],PRD_ID,ORD_QTY,CST_ID)				
		--		SELECT *,@CST_ID_TEMP AS [CST_ID] FROM OPENXML(@XMLID,'/root/ordrow',2)
		--		WITH (
		--			[PRD_NAME]  VARCHAR(200),			
		--			[PRD_ID]  INT,			
		--			[ORD_QTY] INT

		--		  )

		--		SELECT 'SUCCESS'
		--	END
		IF @QRY_ID='PRD_INSERT'
			BEGIN
				INSERT INTO PRODUCT_MAS([PRD_NAME],[PRD_PRICE])
				SELECT * FROM OPENXML(@XMLID,'/root/row',2)
				WITH (
					[PRD_NAME]  VARCHAR (200)   ,
					[PRD_PRICE] DECIMAL (20, 2) 
				)
				SELECT 'SUCCESS';
			END
		IF @QRY_ID='PRD_SELECT'
			BEGIN
				SELECT * FROM PRODUCT_MAS;
			END
		IF @QRY_ID='PRD_UPDATE'
			BEGIN
				
				SELECT * INTO #TemppPrdUpdte FROM OPENXML(@XMLID,'/root/row',2)
				WITH (
					[PRD_ID]    INT     ,
					[PRD_NAME]  VARCHAR (200)   ,
					[PRD_PRICE] DECIMAL (20, 2) 
				)

				UPDATE  PRODUCT_MAS
				SET PRODUCT_MAS.PRD_NAME =#TemppPrdUpdte.PRD_NAME,					
					PRODUCT_MAS.PRD_PRICE=#TemppPrdUpdte.PRD_PRICE
				FROM #TemppPrdUpdte
				WHERE PRODUCT_MAS.PRD_ID= #TemppPrdUpdte.PRD_ID

				SELECT 'SUCCESS'

			END
		IF @QRY_ID='MONTH_CUST_DATA'
			BEGIN
				SELECT * INTO #TempGetCust FROM OPENXML(@XMLID,'/root/row',2)
				WITH (
					[CST_ID]    varchar(20)     ,
					[ORD_DATE]  VARCHAR (20)   
					
				)
				
			IF EXISTS(SELECT NULL FROM CUSTOMER_ADDON WHERE CST_DATE IN (SELECT ORD_DATE FROM #TempGetCust) AND CST_ID=(SELECT CST_ID FROM #TempGetCust) )
				BEGIN
				
					SELECT A.*,B.CST_ADV,B.CST_CONV,B.CST_DIS,B.CST_DATE FROM 
					CUSTOMER_MAS A FULL JOIN CUSTOMER_ADDON B
					ON A.CST_ID=B.CST_ID		
					WHERE A.CST_ID = (SELECT CST_ID FROM #TempGetCust)
					AND B.CST_DATE = (SELECT ORD_DATE FROM #TempGetCust)

					SELECT * FROM ORDER_MAS 
					WHERE CST_ID = (SELECT CST_ID FROM #TempGetCust)
					AND ORD_DATE=(SELECT ORD_DATE FROM #TempGetCust);
				END
			ELSE
				BEGIN
					SELECT *,0 CST_ADV,0 CST_CONV,0 CST_DIS FROM CUSTOMER_MAS 
					WHERE CST_ID = (SELECT CST_ID FROM #TempGetCust)
										
					
					SELECT * FROM ORDER_MAS 
					WHERE CST_ID = (SELECT CST_ID FROM #TempGetCust)
					AND ORD_DATE=(SELECT ORD_DATE FROM #TempGetCust);
				END

				
			END
		IF @QRY_ID='MONTH_DATA_DETAIL'
			BEGIN

			
				SELECT * INTO #TEMPCUSTADD  FROM OPENXML(@XMLID,'/root/row',2)
				WITH (
				 CST_ID VARCHAR(20), CST_ADV DECIMAL(20,2), CST_CONV DECIMAL(20,2), CST_DIS DECIMAL(20,2) ,ORD_DATE VARCHAR(20)
				 )

				 DELETE FROM CUSTOMER_ADDON
				 WHERE CST_ID IN (SELECT CST_ID FROM #TEMPCUSTADD)
				 AND CST_DATE IN (SELECT ORD_DATE FROM #TEMPCUSTADD)

				 
				 INSERT INTO CUSTOMER_ADDON(CST_ID,CST_ADV,CST_CONV,CST_DIS,CST_DATE)
				 SELECT CST_ID,CST_ADV,CST_CONV,CST_DIS,ORD_DATE FROM  #TEMPCUSTADD

				 DELETE FROM ORDER_MAS
				 WHERE CST_ID IN (SELECT CST_ID FROM #TEMPCUSTADD)
				 AND ORD_DATE IN (SELECT ORD_DATE FROM #TEMPCUSTADD)
				 
				 SELECT * INTO #TEMPORDMAS  FROM OPENXML(@XMLID,'/root/orow',2)
				 WITH (
				 PRD_ID INT,PRD_NAME VARCHAR(100),ORD_QTY INT
				 )
				 
				 INSERT INTO ORDER_MAS(PRD_NAME,PRD_ID,CST_ID,ORD_QTY,ORD_DATE)
				 SELECT A.PRD_NAME,A.PRD_ID,B.CST_ID,A.ORD_QTY,B.ORD_DATE FROM  #TEMPORDMAS A  ,#TEMPCUSTADD B

				 select 'success'
			END
		IF @QRY_ID='DAILY_PROCESS'
		BEGIN
			SELECT * INTO #TEMPMNTHORD  FROM OPENXML(@XMLID,'/root/row',2)
			WITH(DATE_DAY VARCHAR(50),DATE_MONTH VARCHAR(30))
			
			

			select @TEMPCOL= STUFF((SELECT distinct ',isNull(' +QUOTENAME(c.PRD_ID)+',0) AS '''+ QUOTENAME(c.PRD_ID)+':'+c.PRD_NAME +''''
				FROM PRODUCT_MAS C
				FOR XML PATH(''), TYPE
				).value('.', 'NVARCHAR(MAX)') 
			,1,1,'')

			SELECT @TEMPCOL1= STUFF((SELECT DISTINCT ',' + QUOTENAME(C.PRD_ID)
				FROM PRODUCT_MAS C
				FOR XML PATH(''), TYPE
				).value('.', 'NVARCHAR(MAX)') 
			,1,1,'')

			IF EXISTS(SELECT NULL FROM ORDER_PROCESS WHERE ORD_DATE=(SELECT DATE_DAY FROM #TEMPMNTHORD))
			BEGIN
				SELECT @TEMPDATE =DATE_DAY FROM #TEMPMNTHORD;
				EXEC('
				SELECT CST_ID,CST_BLK_ID,CST_FLAT_NO,'+@TEMPCOL+' FROM (
					SELECT A.ORD_CST_ID AS CST_ID,A.ORD_PRD_ID,A.ORD_QTY_ID,B.CST_BLK_ID,B.CST_FLAT_NO
					FROM ORDER_PROCESS A  JOIN CUSTOMER_MAS B
					ON A.ORD_CST_ID=B.CST_ID
					WHERE ORD_DATE='''+@TEMPDATE+'''
				) SOURCE
				  PIVOT 
						(
						SUM(ORD_QTY_ID) FOR ORD_PRD_ID IN ('+@TEMPCOL1+') 
						) AS PIVOTTAB

				');
			END
			ELSE
			BEGIN
				SELECT @TEMPDATE =DATE_MONTH FROM #TEMPMNTHORD;
				EXEC('
					SELECT CST_ID,CST_BLK_ID,CST_FLAT_NO,'+@TEMPCOL+' FROM (
						SELECT A.CST_ID,A.PRD_ID,A.ORD_QTY,B.CST_BLK_ID,B.CST_FLAT_NO
						FROM ORDER_MAS A  JOIN CUSTOMER_MAS B
						ON A.CST_ID=B.CST_ID
						WHERE ORD_DATE='''+@TEMPDATE+'''
					) SOURCE
					  PIVOT 
							(
							SUM(ORD_QTY) FOR PRD_ID IN ('+@TEMPCOL1+') 
							) AS PIVOTTAB

					');	
			END
			

		
		END
		IF @QRY_ID='PROCEED_DATA'
		BEGIN
			SELECT @TEMPDATE=DATE_DAY FROM OPENXML(@XMLID,'/root/drow',2)
				WITH (
					DATE_DAY  VARCHAR (50)   			
				)
			IF EXISTS(SELECT NULL FROM ORDER_PROCESS WHERE ORD_DATE=@TEMPDATE)
			BEGIN
				DELETE FROM ORDER_PROCESS WHERE ORD_DATE=@TEMPDATE;
				INSERT INTO ORDER_PROCESS(ORD_CST_ID,ORD_PRC_ID,ORD_PRD_ID,ORD_QTY_ID,ORD_DATE)
				SELECT * FROM OPENXML(@XMLID,'/root/row',2)
				WITH (
					CST_ID  VARCHAR (50) ,
					ORD_PRC_ID VARCHAR(200)  ,
					PRD_ID INT,
					PRD_QTY INT,
					PRD_DATE VARCHAR(50)
				)
				SELECT 'UPDATED'
			END
			ELSE
			BEGIN
				INSERT INTO ORDER_PROCESS(ORD_CST_ID,ORD_PRC_ID,ORD_PRD_ID,ORD_QTY_ID,ORD_DATE)
				SELECT * FROM OPENXML(@XMLID,'/root/row',2)
				WITH (
					CST_ID  VARCHAR (50) ,
					ORD_PRC_ID VARCHAR(200)  ,
					PRD_ID INT,
					PRD_QTY INT,
					PRD_DATE VARCHAR(50)
				)
				SELECT 'INSERTED'
			END
		
		END
		IF @QRY_ID='MONTH_BILL'
		BEGIN
			SELECT @TEMPDATE=DATE_MONTH  FROM OPENXML(@XMLID,'/root/row',2)
			WITH(DATE_MONTH VARCHAR(30))
			-------
			SELECT * FROM(
					SELECT ORD_CST_ID CST_ID,PRD_NAME PRODUCTS,QTY,PRD_PRICE PRICE,(QTY*PRD_PRICE)  SUB_TOTAL,NULL TOTAL ,NULL ADV ,NULL CONV,NULL DIS FROM (
						SELECT A.ORD_CST_ID,A.ORD_PRD_ID,D.PRD_NAME,SUM(A.ORD_QTY_ID) QTY,D.PRD_PRICE 
						FROM ORDER_PROCESS A 
						JOIN PRODUCT_MAS D ON A.ORD_PRD_ID=D.PRD_ID
						WHERE A.ORD_DATE LIKE ''+@TEMPDATE+'%'
						GROUP BY A.ORD_CST_ID,A.ORD_PRD_ID,D.PRD_PRICE,D.PRD_NAME
						)SUB1
				
					WHERE QTY <>0
					UNION
					SELECT ORD_CST_ID AS CST_ID,NULL PRODUCTS, SUM(QTY),NULL PRICE, SUM(QTY*PRD_PRICE) 'SUB_TOTAL',SUM(QTY*PRD_PRICE)-(B.CST_ADV+B.CST_DIS)+B.CST_CONV TOTAL
					, B.CST_ADV ADV ,B.CST_CONV CONV,B.CST_DIS DIS
					FROM(
						
						SELECT A.ORD_CST_ID,D.PRD_ID,D.PRD_NAME,SUM(A.ORD_QTY_ID) QTY,D.PRD_PRICE 
						FROM ORDER_PROCESS A 
						JOIN PRODUCT_MAS D ON A.ORD_PRD_ID=D.PRD_ID
						WHERE A.ORD_DATE LIKE ''+@TEMPDATE+'%'
						GROUP BY A.ORD_CST_ID,D.PRD_ID,D.PRD_PRICE,D.PRD_NAME
				
						)SUB1
			
					FULL JOIN CUSTOMER_ADDON B ON SUB1.ORD_CST_ID=B.CST_ID	
					WHERE B.CST_DATE LIKE ''+@TEMPDATE+'%'
					GROUP BY ORD_CST_ID,B.CST_ADV,B.CST_CONV,B.CST_DIS 
					)SUB2
				
			ORDER BY CST_ID,PRODUCTS DESC
			-----------
			SELECT ORD_CST_ID CST_ID,PRD_NAME PRODUCTS,QTY,PRD_PRICE PRICE,(QTY*PRD_PRICE)  SUB_TOTAL,NULL TOTAL ,NULL ADV ,NULL CONV,NULL DIS FROM (
						SELECT A.ORD_CST_ID,A.ORD_PRD_ID,D.PRD_NAME,SUM(A.ORD_QTY_ID) QTY,D.PRD_PRICE 
						FROM ORDER_PROCESS A 
						JOIN PRODUCT_MAS D ON A.ORD_PRD_ID=D.PRD_ID
						WHERE A.ORD_DATE LIKE ''+@TEMPDATE+'%'
						GROUP BY A.ORD_CST_ID,A.ORD_PRD_ID,D.PRD_PRICE,D.PRD_NAME
						)SUB1
				
			WHERE QTY <>0
			-------
			SELECT ORD_CST_ID AS CST_ID,NULL PRODUCTS, SUM(QTY),NULL PRICE, SUM(QTY*PRD_PRICE) 'SUB_TOTAL',SUM(QTY*PRD_PRICE)-(B.CST_ADV+B.CST_DIS)+B.CST_CONV TOTAL
					, B.CST_ADV ADV ,B.CST_CONV CONV,B.CST_DIS DIS,W.CST_NAME CNAME,W.CST_MOBILE MOB,CST_REMARK REMARK
					FROM(
						
						SELECT A.ORD_CST_ID,D.PRD_ID,D.PRD_NAME,SUM(A.ORD_QTY_ID) QTY,D.PRD_PRICE 
						FROM ORDER_PROCESS A 
						JOIN PRODUCT_MAS D ON A.ORD_PRD_ID=D.PRD_ID
						WHERE A.ORD_DATE LIKE ''+@TEMPDATE+'%'
						GROUP BY A.ORD_CST_ID,D.PRD_ID,D.PRD_PRICE,D.PRD_NAME
				
						)SUB1
			
					FULL JOIN CUSTOMER_ADDON B ON SUB1.ORD_CST_ID=B.CST_ID	
					JOIN CUSTOMER_MAS W ON SUB1.ORD_CST_ID=W.CST_ID
					WHERE B.CST_DATE LIKE ''+@TEMPDATE+'%'			
					GROUP BY ORD_CST_ID,B.CST_ADV,B.CST_CONV,B.CST_DIS,W.CST_NAME,W.CST_MOBILE,W.CST_REMARK 
			
		END
		IF @QRY_ID='MONTH_CUST_ORD_DETAIL'
		BEGIN
			SELECT @TEMPDATE=DATE_MONTH, @CST_ID_TEMP =CST_ID FROM OPENXML(@XMLID,'/root/row',2)
			WITH(DATE_MONTH VARCHAR(30),CST_ID VARCHAR(50))	

			SELECT A.ORD_PRC_ID,B.PRD_NAME,A.ORD_QTY_ID INTO #TEMPPRDDETAILS FROM ORDER_PROCESS A
				JOIN PRODUCT_MAS B ON A.ORD_PRD_ID=B.PRD_ID
				WHERE A.ORD_CST_ID=''+@CST_ID_TEMP+''
				AND ORD_QTY_ID <> 0
				AND ORD_DATE LIKE ''+@TEMPDATE+'%'
				GROUP BY B.PRD_NAME,A.ORD_PRC_ID,A.ORD_QTY_ID

			select @TEMPCOL= STUFF((SELECT distinct ',isNull(' +QUOTENAME(c.PRD_NAME)+',0) AS '''+ (c.PRD_NAME)+''''
				FROM #TEMPPRDDETAILS C
				FOR XML PATH(''), TYPE
				).value('.', 'NVARCHAR(MAX)') 
			,1,1,'')

			SELECT @TEMPCOL1= STUFF((SELECT DISTINCT ',' + QUOTENAME(C.PRD_NAME)
				FROM #TEMPPRDDETAILS C
				FOR XML PATH(''), TYPE
				).value('.', 'NVARCHAR(MAX)') 
			,1,1,'')

			
			EXEC('SELECT * FROM(
						SELECT ORD_PRC_ID,'+@TEMPCOL+' FROM (
							SELECT * FROM #TEMPPRDDETAILS 
						) SOURCE
						  PIVOT 
								(
								SUM(ORD_QTY_ID) FOR PRD_NAME IN  ('+@TEMPCOL1+') 
								) AS PIVOTTAB
								)SUBROUTE
				ORDER BY ORD_PRC_ID
					');	
				
			
		END

		IF @QRY_ID='MONTH_STATEMENT'
		BEGIN

		SELECT @TEMPDATE=DATE_MONTH  FROM OPENXML(@XMLID,'/root/row',2)
			WITH(DATE_MONTH VARCHAR(30))
			

		select @TEMPCOL= STUFF((SELECT distinct ',isNull(' +QUOTENAME(c.ORD_PRC_ID)+',0) AS '''+c.ORD_PRC_ID +''''
				FROM ORDER_PROCESS C WHERE ORD_DATE LIKE ''+@TEMPDATE+'%' ORDER BY ',isNull(' +QUOTENAME(c.ORD_PRC_ID)+',0) AS '''+c.ORD_PRC_ID +''''
				FOR XML PATH(''), TYPE
				).value('.', 'NVARCHAR(MAX)') 
			,1,1,'')

			SELECT @TEMPCOL1= STUFF((SELECT DISTINCT ',' + QUOTENAME(C.ORD_PRC_ID)
				FROM ORDER_PROCESS C WHERE ORD_DATE LIKE ''+@TEMPDATE+'%' ORDER BY ',' + QUOTENAME(C.ORD_PRC_ID)
				FOR XML PATH(''), TYPE
				).value('.', 'NVARCHAR(MAX)') 
			,1,1,'')

			IF EXISTS(SELECT NULL FROM ORDER_PROCESS WHERE ORD_DATE LIKE ''+@TEMPDATE+'%')
			BEGIN
				EXEC('
				SELECT CST_ID,CST_BLK_ID,CST_FLAT_NO,PRD_NAME,'+@TEMPCOL+' FROM (
					
					SELECT A.ORD_CST_ID AS CST_ID,A.ORD_PRD_ID,C.PRD_NAME,A.ORD_PRC_ID,A.ORD_QTY_ID,B.CST_BLK_ID,B.CST_FLAT_NO
					FROM ORDER_PROCESS A  JOIN CUSTOMER_MAS B
					ON A.ORD_CST_ID=B.CST_ID
					JOIN PRODUCT_MAS C
					ON A.ORD_PRD_ID=C.PRD_ID
					WHERE ORD_DATE LIKE '''+@TEMPDATE+'%''
					AND ORD_QTY_ID <>0
					
				) SOURCE 
				  PIVOT 
						(
						SUM(ORD_QTY_ID) FOR ORD_PRC_ID IN ('+@TEMPCOL1+') 
						) AS PIVOTTAB
			     
				');
				END

				
		END
	 END

	 
	 



